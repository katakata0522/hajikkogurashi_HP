name: Deploy to Xserver

on:
  push:
    branches:
      - main # または main。リポジトリのデフォルトブランチに合わせてください

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1' # 必要に応じてバージョンを調整
          bundler-cache: true

      - name: Build Jekyll site
        run: |
          bundle install
          bundle exec jekyll build

      - name: Deploy to Xserver via Rsync
        env:
          XS_SSH_KEY: ${{ secrets.XS_SSH_KEY }}
          XS_HOST: ${{ secrets.XS_HOST }}
          XS_PORT: ${{ secrets.XS_PORT }}
          XS_USER: ${{ secrets.XS_USER }}
          XS_REMOTE_DIR: ${{ secrets.XS_REMOTE_DIR }}
        run: |
          # SSHディレクトリの準備
          mkdir -p ~/.ssh
          echo "$XS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 既知のホストとして登録（対話モード回避）
          ssh-keyscan -p $XS_PORT -H $XS_HOST >> ~/.ssh/known_hosts

          # rsyncで転送
          # -a: アーカイブモード（属性維持）
          # -v: 詳細表示
          # -z: 圧縮転送
          # --delete: ローカルにないファイルはサーバーからも削除（同期）
          rsync -avz --delete -e "ssh -p $XS_PORT -i ~/.ssh/id_rsa" ./_site/ $XS_USER@$XS_HOST:$XS_REMOTE_DIR
